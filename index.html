        <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoAlerta</title>
    
    <meta name="theme-color" content="#4f46e5"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSIyNCIgZmlsbD0iIzRmNDZlNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iODAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiPkdBPC90ZXh0Pjwvc3ZnPg==">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        /* Estilos CSS (Modificados para m√≥vil) */
        #map {
            height: 100%;
            width: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .leaflet-container { cursor: crosshair !important; }
        .notification { transition: all 0.5s ease-in-out; opacity: 1; }
        .notification.fade-out { opacity: 0; transform: translateX(100%); }
        /* Estilo para el marcador del <details> */
        summary::marker {
            content: '‚ñ∂ ';
            font-size: 0.8em;
        }
        details[open] summary::marker {
            content: '‚ñº ';
        }
        /* Ocultar marcador en Chrome/Safari */
        summary {
            list-style: none; /* Safari */
        }
        summary::-webkit-details-marker {
            display: none; /* Chrome */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col sm:flex-row h-screen overflow-hidden">

    <aside class="w-full sm:w-1/3 lg:w-1/4 xl:w-1/5 h-[40vh] sm:h-screen bg-white shadow-lg flex flex-col z-10">
        <div class="p-4 border-b">
            <h1 class="text-xl font-bold text-gray-800">GeoAlerta</h1>
            <p class="text-sm text-gray-600">Datos cargados desde el repositorio.</p>
        </div>

        <div class="p-4 border-b">
            <h2 class="font-semibold text-gray-800 mb-2">Capas Globales</h2>
            <div class="flex items-center">
                <input id="toggle-tasks" type="checkbox" class="h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-gray-500">
                <label for="toggle-tasks" class="ml-2 block text-sm text-gray-900">Mostrar TODAS las Tareas (Puntos)</label>
            </div>
            
            <h3 class="font-semibold text-gray-800 mt-3 mb-1 text-sm">Mapas de Calor (Categor√≠as)</h3>
            <div id="layer-toggles" class="space-y-1 max-h-24 overflow-y-auto">
                 <p class="text-xs text-gray-400 italic">Cargando categor√≠as...</p>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-y-auto">
            <div class="flex justify-between items-center mb-2 gap-2">
                <h2 class="font-semibold text-gray-800 shrink-0">Alertas Proximidad</h2>
                <div class="flex gap-1">
                    <button id="locate-me" class="text-xs sm:text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded-md hover:bg-blue-200 transition-colors">Ubicaci√≥n</button>
                    <button id="paste-coords" class="text-xs sm:text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md hover:bg-indigo-200 transition-colors">Pegar</button>
                    <button id="street-view" class="text-xs sm:text-sm bg-green-100 text-green-700 px-2 py-1 rounded-md hover:bg-green-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Street View</button>
                </div>
            </div>
            
            <p class="text-sm text-gray-500 mb-3" id="alerts-instructions">Cargando datos de Tareas y Postes...</p>
            <div id="alerts-panel" class="space-y-3">
                <div class="text-center text-gray-400 italic" id="alerts-placeholder">Cargando datos...</div>
            </div>
        </div>

        <div class="p-4 border-t text-xs text-gray-400">
            App GeoAlerta v3.7 (con Heatmaps)
        </div>
    </aside>

    <main class="flex-1 h-[60vh] sm:h-full w-full">
        <div id="map"></div>
    </main>

    <div id="notification-container" class="fixed bottom-4 right-4 z-[2000] w-80 space-y-3">
        </div>

    <script>
        // --- Variables Globales ---
        let map;
        let allTasksData = []; // Solo los datos de tareas
        let allPoles = [];
        
        let taskLayerGroup = L.layerGroup();         // Para "Mostrar TODAS" (Puntos)
        let keywordHeatData = {};                    // Para datos de heatmap [lat, lng]
        let keywordHeatLayers = {};                  // Para los objetos L.heatLayer
        
        let proximityPolesLayerGroup = L.layerGroup(); 
        let proximityTaskLayerGroup = L.layerGroup();
        
        let proximityMarker = null;
        let isDataLoaded = false;
        let pendingSharedLatLng = null;
        let selectedLatLng = null; 

        // --- NOMBRES DE ARCHIVO (URLs de "View Raw" del usuario) ---
        const TASK_FILE_NAME = 'https://raw.githubusercontent.com/rodox2886/GeoAlerta/main/LMZ%20Octubre.xlsx';
        const POLE_FILE_NAME = 'https://raw.githubusercontent.com/rodox2886/GeoAlerta/main/Postes.xlsx';

        // --- Constantes de Radios ---
        const PROXIMITY_RADIUS = 50;
        const CUSTODY_RADIUS = 200;
        const POLE_RADIUS = 100;

        // --- Funci√≥n de Notificaci√≥n ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const bgColor = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-green-600' : 'bg-blue-600');
            const notification = document.createElement('div');
            notification.className = `notification ${bgColor} text-white p-4 rounded-lg shadow-lg flex items-start`;
            notification.innerHTML = `<div class="flex-1">${message}</div><button class="ml-2 text-xl font-bold leading-none">√ó</button>`;
            notification.querySelector('button').onclick = () => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            };
            container.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => { if (notification.parentElement) notification.remove(); }, 500);
            }, 5000);
        }

        // --- Iconos Personalizados ---
        const taskIcon = L.divIcon({
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-red-600 drop-shadow-lg"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.74a3.25 3.25 0 0 1-2.598 4.875H4.644a3.25 3.25 0 0 1-2.598-4.875L9.4 3.003ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" /></svg>`,
            className: 'bg-transparent border-0', iconSize: [24, 24], iconAnchor: [12, 24]
        });
        const poleIcon = L.divIcon({
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-600 drop-shadow-lg"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" /></svg>`,
            className: 'bg-transparent border-0', iconSize: [24, 24], iconAnchor: [12, 24]
        });
        const clickIcon = L.divIcon({
            html: `<div class="w-4 h-4 bg-yellow-400 border-2 border-black rounded-full shadow-lg opacity-80"></div>`,
            className: 'bg-transparent border-0', iconSize: [16, 16], iconAnchor: [8, 8]
        });

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            document.getElementById('toggle-tasks').addEventListener('change', toggleAllTasksLayer); 
            document.getElementById('paste-coords').addEventListener('click', handlePaste);
            document.getElementById('locate-me').addEventListener('click', handleLocateMe);
            document.getElementById('street-view').addEventListener('click', openStreetView);
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado:', registration))
                    .catch(error => console.log('Fallo registro Service Worker:', error));
            }

            loadDataFromRepo();

            const urlParams = new URLSearchParams(window.location.search);
            const sharedText = urlParams.get('text') || urlParams.get('url'); 
            if (sharedText) {
                document.getElementById('alerts-instructions').innerText = "Procesando coordenadas recibidas...";
                handleSharedURL(sharedText);
            }
        });

        // --- Funciones del Mapa ---
        function initMap() {
            map = L.map('map').setView([-34.72, -58.56], 12); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            proximityPolesLayerGroup.addTo(map);
            proximityTaskLayerGroup.addTo(map);
            // Las capas globales se gestionan por checkboxes
            
            map.on('click', onMapClick);
            
            const event = new Event('mapInitialized');
            document.dispatchEvent(event);
        }

        function onMapClick(e) {
            triggerAlertsAt(e.latlng, "Clic en mapa");
        }

        // --- Funci√≥n Street View ---
        function openStreetView() {
            if (selectedLatLng) {
                const lat = selectedLatLng.lat;
                const lng = selectedLatLng.lng;
                const url = `http://maps.google.com/maps?q=&layer=c&cbll=${lat},${lng}`;
                window.open(url, '_blank'); 
            } else {
                showNotification("Primero selecciona un punto en el mapa.", "info");
            }
        }

        // --- Funci√≥n Ubicaci√≥n ---
        function handleLocateMe() {
            if (!navigator.geolocation) {
                showNotification("La geolocalizaci√≥n no es soportada por tu navegador.", "error");
                return;
            }
            showNotification("Obteniendo tu ubicaci√≥n...", "info");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const userLatLng = L.latLng(lat, lng);
                    showNotification("Ubicaci√≥n obtenida. Buscando alertas...", "success");
                    if (isDataLoaded) {
                        triggerAlertsAt(userLatLng, "Action");
                    } else {
                        pendingSharedLatLng = userLatLng;
                        document.getElementById('alerts-instructions').innerText = "Cargando datos... Alertas de ubicaci√≥n pendientes.";
                    }
                },
                (error) => {
                    console.error("Error de geolocalizaci√≥n: ", error);
                    let msg = "No se pudo obtener la ubicaci√≥n.";
                    if (error.code === error.PERMISSION_DENIED) msg = "Permiso de ubicaci√≥n denegado.";
                    else if (error.code === error.POSITION_UNAVAILABLE) msg = "Informaci√≥n de ubicaci√≥n no disponible.";
                    else if (error.code === error.TIMEOUT) msg = "Tiempo de espera agotado al obtener ubicaci√≥n.";
                    showNotification(msg, "error");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // --- Funci√≥n Pegar ---
        async function handlePaste() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    showNotification("Texto pegado desde portapapeles.", "info");
                    handleSharedURL(text); 
                } else {
                    showNotification("El portapapeles est√° vac√≠o.", "error");
                }
            } catch (err) {
                console.error('Fallo al leer el portapapeles: ', err);
                showNotification("No se pudo leer el portapapeles. Aseg√∫rate de dar permiso.", "error");
            }
        }
        
        // --- L√≥gica de Share/Paste ---
        function handleSharedURL(text) {
            let lat, lng;
            const coordRegex = /(-?\d{2}\.\d+)[,\s]+(-?\d{2}\.\d+)/;
            const longUrlRegex = /@(-?\d{2}\.\d+),(-?\d{2}\.\d+)/;
            let match = text.match(coordRegex) || text.match(longUrlRegex);
            
            if (match && match[1] && match[2]) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
                
                if (isValidCoord(lat, lng)) {
                    const sharedLatLng = L.latLng(lat, lng);
                    if (isDataLoaded) {
                        triggerAlertsAt(sharedLatLng, "Action");
                    } else {
                        pendingSharedLatLng = sharedLatLng;
                        showNotification("Datos en carga. Mostrando alertas en breve...", "info");
                        document.getElementById('alerts-instructions').innerText = "Cargando datos... Alertas pendientes.";
                    }
                } else {
                    showNotification("Coordenadas compartidas no v√°lidas.", "error");
                }
            } else {
                showNotification("El texto compartido no conten√≠a coordenadas reconocibles.", "error");
            }
        }
        
        // --- Funci√≥n de Alertas ---
        function triggerAlertsAt(latlng, source = "mapa") {
            if (proximityMarker) map.removeLayer(proximityMarker);
            proximityPolesLayerGroup.clearLayers(); 
            proximityTaskLayerGroup.clearLayers();

            proximityMarker = L.marker(latlng, { icon: clickIcon, zIndexOffset: 1000 }).addTo(map);
            map.setView(latlng, 16); 

            findNearbyAlerts(latlng);
            
            selectedLatLng = latlng; 
            document.getElementById('street-view').disabled = false;
            
            if (source === "Action") { 
                showNotification("Alertas cargadas para el punto.", "success");
                document.getElementById('alerts-instructions').innerText = "Mostrando alertas para el punto. Haz clic en otro punto para escanear.";
            } else { // "Clic en mapa"
                 document.getElementById('alerts-instructions').innerText = "Haz clic en el mapa para escanear.";
            }
        }

        // --- Carga de Datos desde Repositorio ---
        async function loadDataFromRepo() {
            try {
                const timestamp = Date.now();
                const taskUrl = `${TASK_FILE_NAME}?t=${timestamp}`;
                const poleUrl = `${POLE_FILE_NAME}?t=${timestamp}`;

                console.log("Intentando cargar:", taskUrl);
                console.log("Intentando cargar:", poleUrl);

                const [taskData, poleData] = await Promise.all([
                    loadTaskFile(taskUrl),
                    loadPoleFile(poleUrl)
                ]);

                processTaskData(taskData);
                processPoleData(poleData); 
                
                // Popula las capas globales (de Puntos y de Calor)
                populateGlobalLayers();
                
                // Crear los checkboxes de capas
                createLayerToggles(); 

                isDataLoaded = true;
                showNotification("Datos de Tareas y Postes cargados.", "success");
                document.getElementById('alerts-instructions').innerText = "¬°Listo! Haz clic, comparte o pega coordenadas.";
                document.getElementById('alerts-placeholder').innerText = "Esperando acci√≥n...";

                if (pendingSharedLatLng) {
                    triggerAlertsAt(pendingSharedLatLng, "Action");
                    pendingSharedLatLng = null;
                }

            } catch (error) {
                console.error("Error al cargar datos del repositorio:", error);
                showNotification(`Error fatal al cargar: ${error.message}.`, "error");
                document.getElementById('alerts-instructions').innerText = "Error al cargar datos.";
                document.getElementById('alerts-placeholder').innerText = "Error al cargar datos. Refresca la app.";
            }
        }

        // --- FUNCI√ìN PARA LEER XLSX ---
        async function loadTaskFile(url) {
            try {
                const response = await fetch(url, { cache: "no-store" }); 
                console.log(`Respuesta para ${url}: ${response.status}`);
                 if (!response.ok) {
                    throw new Error(`No se encontr√≥ ${url} (status: ${response.status})`);
                 }
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' }); 
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                return XLSX.utils.sheet_to_json(worksheet);
             } catch (error) {
                 error.url = url; 
                 throw error;
             }
        }

        async function loadPoleFile(url) {
             try {
                const response = await fetch(url, { cache: "no-store" }); 
                console.log(`Respuesta para ${url}: ${response.status}`);
                 if (!response.ok) {
                     throw new Error(`No se encontr√≥ ${url} (status: ${response.status})`);
                 }
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                return XLSX.utils.sheet_to_json(worksheet);
            } catch (error) {
                 error.url = url; 
                 throw error;
             }
        }

        // --- Funciones de Procesamiento de Datos (MODIFICADA) ---
        function processTaskData(data) {
            allTasksData = []; // Limpiar
            
            data.forEach(row => {
                const latKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 1');
                const lngKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 2');
                const plannedTimeKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'fecha de inicio planificada');
                const obsText = row['Observaciones'] || 'Sin observaciones';
                const keywords = analyzeKeywords(obsText);
                const lat = parseFloat(String(row[latKey] || '0').replace(',', '.'));
                const lng = parseFloat(String(row[lngKey] || '0').replace(',', '.'));
                
                let plannedTime = 'N/A';
                const plannedDateTimeStr = row[plannedTimeKey];
                if (plannedDateTimeStr) {
                    const timeMatch = String(plannedDateTimeStr).match(/(\d{1,2}:\d{2}(:\d{2})?)/);
                    if (timeMatch) plannedTime = timeMatch[1];
                    else {
                         const parts = String(plannedDateTimeStr).split(' ');
                         if (parts.length > 1 && parts[1].includes(':')) plannedTime = parts[1];
                    }
                }

                if (isValidCoord(lat, lng) && keywords.length > 0) {
                    const task = {
                        latlng: L.latLng(lat, lng),
                        id: row['Id TdC'] || 'N/A',
                        direccion: row['Direcci√≥n'] || 'N/A',
                        causal: row['Causal Resultado'] || 'N/A',
                        obs: obsText,
                        plannedTime: plannedTime,
                        keywords: keywords // Guardar las keywords en la tarea
                    };
                    allTasksData.push(task);
                }
            });
            
            console.log(`Cargadas ${allTasksData.length} tareas (con categor√≠as).`);
            if (allTasksData.length === 0 && data.length > 0) {
                showNotification("No se encontraron tareas con palabras clave (Custodia, Hidro, etc.) en 'Observaciones'.", "info");
            }
        }
        
        // --- NUEVA FUNCI√ìN: Poblar las capas globales ---
        function populateGlobalLayers() {
            taskLayerGroup.clearLayers();
            keywordHeatData = {}; // <-- Almacena los [lat,lng]
            keywordHeatLayers = {}; // <-- Almacena los L.heatLayer
            
            allTasksData.forEach((task) => {
                // 1. Crear marcador para "Mostrar TODAS"
                const popupContent = `<div class="w-64"><h3 class="font-bold text-red-700">Tarea: ${task.id}</h3><p class="text-sm"><strong>Direcci√≥n:</strong> ${task.direccion}</p><p class="text-sm"><strong>Causal:</strong> ${task.causal}</p><hr class="my-1"><p class="text-sm font-medium"><strong>Observaciones:</strong></p><p class="text-sm italic bg-red-50 p-1 rounded">${task.obs}</p></div>`;
                const marker = L.marker(task.latlng, { icon: taskIcon }).bindPopup(popupContent);
                taskLayerGroup.addLayer(marker); // A√±adir a la capa de Puntos

                // 2. Preparar datos para "Mapas de Calor"
                task.keywords.forEach(kw => {
                    if (!keywordHeatData[kw]) {
                        keywordHeatData[kw] = [];
                    }
                    keywordHeatData[kw].push([task.latlng.lat, task.latlng.lng]); // A√±adir Coordenadas
                });
            });
            
            console.log("Categor√≠as de Heatmap:", Object.keys(keywordHeatData));
        }

        function processPoleData(data) {
            allPoles = [];
            data.forEach(row => {
                const latKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 1');
                const lngKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 2');
                const lat = parseFloat(String(row[latKey] || '0').replace(',', '.'));
                const lng = parseFloat(String(row[lngKey] || '0').replace(',', '.'));

                if (isValidCoord(lat, lng)) {
                    allPoles.push({
                        latlng: L.latLng(lat, lng),
                        id: row['#TPLNR'] || 'N/A',
                        desc: row['DESCRIPT'] || 'Poste 11m',
                        calle: row['CALLE'] || 'N/A',
                        altura: row['ALTURA_DESDE'] || 'N/A'
                    });
                }
            });
            console.log(`Cargados ${allPoles.length} postes en memoria.`);
        }
        
        function isValidCoord(lat, lng) {
            return lat && lng && !isNaN(lat) && !isNaN(lng) && lat_lng_Validator(lat,lng);
        }

        function lat_lng_Validator(lat, lng) {
            if (lat < -90 || lat > 90) return false;
            if (lng < -180 || lng > 180) return false;
            return true;
        }

        // --- NUEVA: Funci√≥n para crear los checkboxes de capas ---
        function createLayerToggles() {
            const container = document.getElementById('layer-toggles');
            container.innerHTML = ''; // Limpiar "Cargando..."
            
            const keywords = Object.keys(keywordHeatData).sort();
            
            if (keywords.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 italic">No se encontraron categor√≠as.</p>';
                return;
            }

            keywords.forEach(keyword => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                
                // Color tem√°tico para el checkbox
                let colorClass = 'text-gray-600 focus:ring-gray-500';
                if (keyword === 'CUSTODIA') colorClass = 'text-red-600 focus:ring-red-500';
                if (keyword === 'HIDRO' || keyword === 'POSTE 11m') colorClass = 'text-blue-600 focus:ring-blue-500';
                if (keyword === 'POSTE 7.5m') colorClass = 'text-yellow-600 focus:ring-yellow-500';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `toggle-${keyword}`;
                checkbox.value = keyword;
                checkbox.className = `h-4 w-4 ${colorClass} border-gray-300 rounded`;
                checkbox.addEventListener('change', onToggleKeywordLayer);
                
                const label = document.createElement('label');
                label.htmlFor = `toggle-${keyword}`;
                label.className = 'ml-2 block text-sm text-gray-900';
                label.textContent = `Mostrar ${keyword} (Calor)`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        // --- MODIFICADA: Handler para los checkboxes (ahora crea L.heatLayer) ---
        function onToggleKeywordLayer(e) {
            const keyword = e.target.value;
            let layer = keywordHeatLayers[keyword]; // Busca la capa de calor existente
            
            if (e.target.checked) {
                if (!layer) {
                    // Si no existe, la crea
                    const coords = keywordHeatData[keyword];
                    if (!coords || coords.length === 0) return;
                    
                    layer = L.heatLayer(coords, {
                        radius: 25,
                        blur: 20,
                        maxZoom: 18
                    });
                    keywordHeatLayers[keyword] = layer; // Guarda la capa creada
                }
                map.addLayer(layer); // A√±ade al mapa
            } else {
                if (layer) {
                    map.removeLayer(layer); // Quita del mapa
                }
            }
        }
        
        // --- Handler para el checkbox "Mostrar TODAS" (Puntos) ---
        function toggleAllTasksLayer(e) {
            if (e.target.checked) {
                map.addLayer(taskLayerGroup);
            } else {
                map.removeLayer(taskLayerGroup);
            }
        }


        // --- Funciones del "Alertador" (MODIFICADAS) ---
        function findNearbyAlerts(clickedLatLng) {
            const alertsPanel = document.getElementById('alerts-panel');
            alertsPanel.innerHTML = '';
            proximityTaskLayerGroup.clearLayers();
            proximityPolesLayerGroup.clearLayers(); 

            // --- DIBUJAR POSTES CERCANOS EN EL MAPA ---
            allPoles.forEach(pole => {
                const distance = clickedLatLng.distanceTo(pole.latlng);
                if (distance <= POLE_RADIUS) {
                    const popupContent = `<div class="w-64"><h3 class="font-bold text-blue-700">Poste: ${pole.id}</h3><p class="text-sm"><strong>Desc:</strong> ${pole.desc}</p><p class="text-sm"><strong>Calle:</strong> ${pole.calle} ${pole.altura}</p><hr class="my-1"><p class="text-sm font-medium bg-blue-50 p-1 rounded"><strong>¬°Atenci√≥n!</strong> Poste de 11m, probable necesidad de hidroelevador.</p></div>`;
                    L.marker(pole.latlng, { icon: poleIcon })
                        .bindPopup(popupContent)
                        .addTo(proximityPolesLayerGroup);
                }
            });
            // --- FIN DE POSTES ---


            // --- 1. Agrupar Tareas ---
            let taskGroups = {};
            let foundTasks = 0;

            allTasksData.forEach((task) => { // Iterar sobre los datos de tareas
                const distance = clickedLatLng.distanceTo(task.latlng);
                
                const keywords = task.keywords; // Usar keywords ya guardadas
                const needsCustody = keywords.includes('CUSTODIA');
                const mentionsPole11m = keywords.includes('POSTE 11m') || keywords.includes('HIDRO');
                let effectiveRadius = PROXIMITY_RADIUS;
                if (needsCustody) effectiveRadius = CUSTODY_RADIUS;
                else if (mentionsPole11m) effectiveRadius = POLE_RADIUS;

                if (distance <= effectiveRadius) {
                    foundTasks++; // Contar tareas totales
                    
                    // --- A√±adir marcador al mapa de proximidad ---
                    // (Creamos un nuevo marcador solo para esta capa temporal)
                    const popupContent = `<div class="w-64"><h3 class="font-bold text-red-700">Tarea: ${task.id}</h3><p class="text-sm"><strong>Direcci√≥n:</strong> ${task.direccion}</p><p class="text-sm"><strong>Causal:</strong> ${task.causal}</p><hr class="my-1"><p class="text-sm font-medium"><strong>Observaciones:</strong></p><p class="text-sm italic bg-red-50 p-1 rounded">${task.obs}</p></div>`;
                    L.marker(task.latlng, { icon: taskIcon })
                        .bindPopup(popupContent)
                        .addTo(proximityTaskLayerGroup);

                    // --- A√±adir a grupos para el panel ---
                    keywords.forEach(kw => {
                        if (!taskGroups[kw]) {
                            taskGroups[kw] = []; // Inicializar array
                        }
                        // Solo a√±adir una vez al grupo del panel
                        if (!taskGroups[kw].some(t => t.id === task.id)) {
                             taskGroups[kw].push(task); // A√±adir la tarea
                        }
                    });
                }
            });

            // --- 2. Renderizar Grupos ---
            if (foundTasks === 0) {
                alertsPanel.innerHTML = `<div class="text-center text-gray-500 italic">No se encontraron tareas con alertas en los radios de b√∫squeda.</div>`;
                return;
            }

            const sortedKeywords = Object.keys(taskGroups).sort();
            
            sortedKeywords.forEach(keyword => {
                const tasks = taskGroups[keyword];
                const groupCard = createTaskGroupCard(keyword, tasks); // Nueva funci√≥n
                alertsPanel.appendChild(groupCard);
            });
        }

        /**
         * Crea una tarjeta de grupo colapsable (<details>)
         */
        function createTaskGroupCard(keyword, tasks) {
            const el = document.createElement('details');
            el.className = 'bg-white rounded-lg shadow overflow-hidden';
            
            // Definir color/icono por keyword
            let headerColor = 'bg-gray-100 text-gray-800'; // default
            if (keyword === 'CUSTODIA') headerColor = 'bg-red-100 text-red-800';
            if (keyword === 'HIDRO' || keyword === 'POSTE 11m') headerColor = 'bg-blue-100 text-blue-800';
            if (keyword === 'POSTE 7.5m') headerColor = 'bg-yellow-100 text-yellow-800';

            const summary = document.createElement('summary');
            summary.className = `p-3 font-semibold ${headerColor} cursor-pointer flex justify-between items-center transition-colors hover:bg-gray-200`;
            summary.innerHTML = `
                <span class="flex items-center">
                    <span class="mr-2">${keyword === 'CUSTODIA' ? 'üö®' : (keyword.includes('POSTE') ? 'üí°' : 'üîß')}</span>
                    ${keyword}
                </span>
                <span class="text-sm font-normal px-2 bg-white rounded-full">${tasks.length} Tarea(s)</span>
            `;
            el.appendChild(summary);

            // --- 2. Crear el contenido (la lista de tareas) ---
            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-3 space-y-2 border-t border-gray-200 bg-white';
            
            tasks.forEach(task => {
                const taskCard = createSimpleTaskCard(task); // Usar una funci√≥n helper
                contentDiv.appendChild(taskCard);
            });
            
            el.appendChild(contentDiv);
            return el;
        }

        /**
         * Crea una tarjeta simple para una tarea individual (va dentro del grupo)
         */
        function createSimpleTaskCard(task) {
            const el = document.createElement('div');
            el.className = 'bg-gray-50 p-2 rounded-md border border-gray-200';
            
            let timeHTML = '';
            if (task.keywords.includes('CUSTODIA') && task.plannedTime && task.plannedTime !== 'N/A') {
                timeHTML = `<span class="font-bold text-red-700 ml-2">(Horario: ${task.plannedTime})</span>`;
            }

            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <h5 class="font-bold text-sm text-gray-700">ID Tarea: ${task.id} ${timeHTML}</h5>
                </div>
                <p class="text-xs mt-1"><strong>Causal:</strong> ${task.causal}</p>
                <p class="text-xs mt-1"><strong>Obs:</strong> <em class="italic">${task.obs}</em></p>
            `;
            return el;
        }

        // --- (Sin cambios) ---
        function analyzeKeywords(text) {
            if (!text) return [];
            const lowerText = text.toLowerCase();
            const found = [];
            if (lowerText.includes('hidro') || lowerText.includes('hidroelevador')) found.push('HIDRO');
            if (lowerText.includes('custodia') || lowerText.includes('policia') || lowerText.includes('polic√≠a') || lowerText.includes('peligro') || lowerText.includes('zona peligrosa') || lowerText.includes('inseguro')) found.push('CUSTODIA');
            if (lowerText.includes('11m') || lowerText.includes('11 m') || lowerText.includes('11mtrs') || lowerText.includes('postacion de 11 m')) found.push('POSTE 11m');
            if (lowerText.includes('7,5m') || lowerText.includes('7,5 m') || lowerText.includes('7,5mtrs') || lowerText.includes('7.5m') || lowerText.includes('7.5 m') || lowerText.includes('7.5mtrs')) found.push('POSTE 7.5m');
            if (lowerText.includes('deriva')) found.push('DERIVADO');
            return found;
        }
    </script>
</body>
</html>
