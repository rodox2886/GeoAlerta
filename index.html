<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoAlerta</title>
    
    <meta name="theme-color" content="#4f46e5"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSIyNCIgZmlsbD0iIzRmNDZlNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iODAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiPkdBPC90ZXh0Pjwvc3ZnPg==">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Estilo para el contenedor del mapa */
        #map {
            height: 100vh;
            width: 100%;
        }
        /* Asegura que la fuente Inter se use */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Estilo para el cursor de "crosshair" sobre el mapa */
        .leaflet-container {
            cursor: crosshair !important;
        }
        /* Estilos para notificaciones */
        .notification {
            transition: all 0.5s ease-in-out;
            opacity: 1;
        }
        .notification.fade-out {
            opacity: 0;
            transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <aside class="w-full sm:w-1/3 lg:w-1/4 xl:w-1/5 h-screen bg-white shadow-lg flex flex-col z-10">
        <div class="p-4 border-b">
            <h1 class="text-xl font-bold text-gray-800">GeoAlerta</h1>
            <p class="text-sm text-gray-600">Datos cargados desde el repositorio.</p>
        </div>

        <div class="p-4 border-b">
            <h2 class="font-semibold text-gray-800 mb-2">Capas</h2>
            <div class="space-y-2">
                <div class="flex items-center">
                    <input id="toggle-tasks" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <label for="toggle-tasks" class="ml-2 block text-sm text-gray-900">Mostrar TODAS las Tareas (Rojo)</label>
                </div>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-y-auto">
            <h2 class="font-semibold text-gray-800 mb-2">Alertas de Proximidad</h2>
            <p class="text-sm text-gray-500 mb-3" id="alerts-instructions">Cargando datos de Tareas y Postes...</p>
            <div id="alerts-panel" class="space-y-3">
                <div class="text-center text-gray-400 italic" id="alerts-placeholder">Cargando datos...</div>
            </div>
        </div>

        <div class="p-4 border-t text-xs text-gray-400">
            App GeoAlerta v2.1
        </div>
    </aside>

    <main class="flex-1 h-screen">
        <div id="map"></div>
    </main>

    <div id="notification-container" class="fixed bottom-4 right-4 z-[2000] w-80 space-y-3">
        </div>

    <script>
        // --- Variables Globales ---
        let map;
        let allTasks = [];
        let allPoles = [];
        let taskLayerGroup = L.layerGroup();
        let proximityPolesLayerGroup = L.layerGroup();
        let proximityTaskLayerGroup = L.layerGroup();
        let proximityMarker = null;

        let isDataLoaded = false;
        let pendingSharedLatLng = null;

// --- Nombres de archivos en el repositorio (VERSIÓN FINAL) ---
const TASK_FILE_NAME = 'https://github.com/rodox2886/GeoAlerta/raw/refs/heads/main/LMZ%20Octubre.xlsx';
const POLE_FILE_NAME = 'https://github.com/rodox2886/GeoAlerta/raw/refs/heads/main/Postes.xlsx';

        const PROXIMITY_RADIUS = 50;
        const CUSTODY_RADIUS = 200;
        const POLE_RADIUS = 100;

        // --- Función de Notificación ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const bgColor = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-green-600' : 'bg-blue-600');
            const notification = document.createElement('div');
            notification.className = `notification ${bgColor} text-white p-4 rounded-lg shadow-lg flex items-start`;
            notification.innerHTML = `<div class="flex-1">${message}</div><button class="ml-2 text-xl font-bold leading-none">&times;</button>`;
            notification.querySelector('button').onclick = () => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            };
            container.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => { if (notification.parentElement) notification.remove(); }, 500);
            }, 5000);
        }

        // --- Iconos Personalizados ---
        const taskIcon = L.divIcon({
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-red-600 drop-shadow-lg"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.74a3.25 3.25 0 0 1-2.598 4.875H4.644a3.25 3.25 0 0 1-2.598-4.875L9.4 3.003ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" /></svg>`,
            className: 'bg-transparent border-0', iconSize: [24, 24], iconAnchor: [12, 24]
        });
        const poleIcon = L.divIcon({
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-600 drop-shadow-lg"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" /></svg>`,
            className: 'bg-transparent border-0', iconSize: [24, 24], iconAnchor: [12, 24]
        });
        const clickIcon = L.divIcon({
            html: `<div class="w-4 h-4 bg-yellow-400 border-2 border-black rounded-full shadow-lg opacity-80"></div>`,
            className: 'bg-transparent border-0', iconSize: [16, 16], iconAnchor: [8, 8]
        });

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            document.getElementById('toggle-tasks').addEventListener('change', toggleLayers);
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado:', registration))
                    .catch(error => console.log('Fallo registro Service Worker:', error));
            }

            loadDataFromRepo();

            const urlParams = new URLSearchParams(window.location.search);
            const sharedText = urlParams.get('text') || urlParams.get('url'); 
            if (sharedText) {
                document.getElementById('alerts-instructions').innerText = "Procesando coordenadas recibidas...";
                handleSharedURL(sharedText);
            }
        });

        // --- Funciones del Mapa ---
        function initMap() {
            map = L.map('map').setView([-34.72, -58.56], 12); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            proximityPolesLayerGroup.addTo(map);
            proximityTaskLayerGroup.addTo(map);
            map.on('click', onMapClick);
            
            const event = new Event('mapInitialized');
            document.dispatchEvent(event);
        }

        function onMapClick(e) {
            triggerAlertsAt(e.latlng, "Clic en mapa");
        }
        
        // --- Lógica de Share Target ---
        function handleSharedURL(text) {
            let lat, lng;
            const coordRegex = /(-?\d{2}\.\d+)[,\s]+(-?\d{2}\.\d+)/;
            const longUrlRegex = /@(-?\d{2}\.\d+),(-?\d{2}\.\d+)/;
            let match = text.match(coordRegex) || text.match(longUrlRegex);
            
            if (match && match[1] && match[2]) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
                
                if (isValidCoord(lat, lng)) {
                    const sharedLatLng = L.latLng(lat, lng);
                    
                    if (isDataLoaded) {
                        triggerAlertsAt(sharedLatLng, "Share");
                    } else {
                        pendingSharedLatLng = sharedLatLng;
                        showNotification("Datos en carga. Mostrando alertas en breve...", "info");
                        document.getElementById('alerts-instructions').innerText = "Cargando datos... Alertas pendientes.";
                    }
                } else {
                    showNotification("Coordenadas compartidas no válidas.", "error");
                }
            } else {
                showNotification("El texto compartido no contenía coordenadas reconocibles.", "error");
            }
        }
        
        // --- Función de Alertas ---
        function triggerAlertsAt(latlng, source = "mapa") {
            if (proximityMarker) map.removeLayer(proximityMarker);
            proximityPolesLayerGroup.clearLayers();
            proximityTaskLayerGroup.clearLayers();

            proximityMarker = L.marker(latlng, { icon: clickIcon, zIndexOffset: 1000 }).addTo(map);
            map.setView(latlng, 16); 

            findNearbyAlerts(latlng);
            
            if (source === "Share") {
                showNotification("Alertas cargadas desde 'Compartir'.", "success");
                document.getElementById('alerts-instructions').innerText = "Mostrando alertas para el punto compartido. Haz clic en otro punto para escanear.";
            } else {
                 document.getElementById('alerts-instructions').innerText = "Haz clic en el mapa para escanear.";
            }
        }

        // --- Carga de Datos desde Repositorio ---
        async function loadDataFromRepo() {
            try {
                const [taskData, poleData] = await Promise.all([
                    loadTaskFile(TASK_FILE_NAME),
                    loadPoleFile(POLE_FILE_NAME)
                ]);

                processTaskData(taskData);
                processPoleData(poleData);

                isDataLoaded = true;
                showNotification("Datos de Tareas y Postes cargados.", "success");
                document.getElementById('alerts-instructions').innerText = "¡Listo! Haz clic en el mapa o comparte desde FSM/Maps.";
                document.getElementById('alerts-placeholder').innerText = "Esperando clic en el mapa...";

                if (pendingSharedLatLng) {
                    triggerAlertsAt(pendingSharedLatLng, "Share");
                    pendingSharedLatLng = null;
                }

            } catch (error) {
                console.error("Error al cargar datos del repositorio:", error);
                showNotification(`Error fatal al cargar archivos: ${error.message}. Revisa los nombres.`, "error");
                document.getElementById('alerts-instructions').innerText = "Error al cargar datos.";
                document.getElementById('alerts-placeholder').innerText = "Error al cargar datos. Refresca la app.";
            }
        }

        async function loadTaskFile(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`No se encontró ${url}`);
            const text = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });
        }

        async function loadPoleFile(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`No se encontró ${url}`);
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            return XLSX.utils.sheet_to_json(worksheet);
        }

        // --- Funciones de Procesamiento de Datos ---
        function processTaskData(data) {
            allTasks = [];
            data.forEach(row => {
                const latKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 1');
                const lngKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 2');
                const plannedTimeKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'fecha de inicio planificada');
                const obsText = row['Observaciones'] || 'Sin observaciones';
                const keywords = analyzeKeywords(obsText);
                const lat = parseFloat(String(row[latKey] || '0').replace(',', '.'));
                const lng = parseFloat(String(row[lngKey] || '0').replace(',', '.'));
                
                let plannedTime = 'N/A';
                const plannedDateTimeStr = row[plannedTimeKey];
                if (plannedDateTimeStr) {
                    const parts = plannedDateTimeStr.split(' ');
                    if (parts.length > 1) plannedTime = parts[1];
                }

                if (isValidCoord(lat, lng) && keywords.length > 0) {
                    const task = {
                        latlng: L.latLng(lat, lng),
                        id: row['Id TdC'] || 'N/A',
                        direccion: row['Dirección'] || 'N/A',
                        causal: row['Causal Resultado'] || 'N/A',
                        obs: obsText,
                        plannedTime: plannedTime
                    };
                    allTasks.push(task);
                    const popupContent = `<div class="w-64"><h3 class="font-bold text-red-700">Tarea: ${task.id}</h3><p class="text-sm"><strong>Dirección:</strong> ${task.direccion}</p><p class="text-sm"><strong>Causal:</strong> ${task.causal}</p><hr class="my-1"><p class="text-sm font-medium"><strong>Observaciones:</strong></p><p class="text-sm italic bg-red-50 p-1 rounded">${task.obs}</p></div>`;
                    L.marker(task.latlng, { icon: taskIcon }).bindPopup(popupContent).addTo(taskLayerGroup);
                }
            });
            console.log(`Cargadas ${allTasks.length} tareas (con categorías).`);
            if (allTasks.length === 0 && data.length > 0) {
                showNotification("No se encontraron tareas con palabras clave (Custodia, Hidro, etc.) en 'Observaciones'.", "info");
            }
        }

        function processPoleData(data) {
            allPoles = [];
            data.forEach(row => {
                const latKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 1');
                const lngKey = Object.keys(row).find(k => k.toLowerCase().trim() === 'coordenada 2');
                const lat = parseFloat(String(row[latKey] || '0').replace(',', '.'));
                const lng = parseFloat(String(row[lngKey] || '0').replace(',', '.'));

                if (isValidCoord(lat, lng)) {
                    allPoles.push({
                        latlng: L.latLng(lat, lng),
                        id: row['#TPLNR'] || 'N/A',
                        desc: row['DESCRIPT'] || 'Poste 11m',
                        calle: row['CALLE'] || 'N/A',
                        altura: row['ALTURA_DESDE'] || 'N/A'
                    });
                }
            });
            console.log(`Cargados ${allPoles.length} postes en memoria.`);
        }
        
        function isValidCoord(lat, lng) {
            return lat && lng && !isNaN(lat) && !isNaN(lng) && lat_lng_Validator(lat,lng);
        }

        function lat_lng_Validator(lat, lng) {
            if (lat < -90 || lat > 90) return false;
            if (lng < -180 || lng > 180) return false;
            return true;
        }

        function toggleLayers() {
            const showTasks = document.getElementById('toggle-tasks').checked;
            if (showTasks) {
                map.addLayer(taskLayerGroup);
            } else {
                map.removeLayer(taskLayerGroup);
            }
        }

        // --- Funciones del "Alertador" ---
        function findNearbyAlerts(clickedLatLng) {
            const alertsPanel = document.getElementById('alerts-panel');
            alertsPanel.innerHTML = '';
            let foundAlerts = 0;

            allPoles.forEach(pole => {
                const distance = clickedLatLng.distanceTo(pole.latlng);
                if (distance <= POLE_RADIUS) {
                    foundAlerts++;
                    alertsPanel.appendChild(createPoleAlertCard(pole, distance, POLE_RADIUS));
                    const popupContent = `<div class="w-64"><h3 class="font-bold text-blue-700">Poste: ${pole.id}</h3><p class="text-sm"><strong>Desc:</strong> ${pole.desc}</p><p class="text-sm"><strong>Calle:</strong> ${pole.calle} ${pole.altura}</p><hr class="my-1"><p class="text-sm font-medium bg-blue-50 p-1 rounded"><strong>¡Atención!</strong> Poste de 11m, probable necesidad de hidroelevador.</p></div>`;
                    L.marker(pole.latlng, { icon: poleIcon }).bindPopup(popupContent).addTo(proximityPolesLayerGroup);
                }
            });

            allTasks.forEach(task => {
                const distance = clickedLatLng.distanceTo(task.latlng);
                const keywords = analyzeKeywords(task.obs);
                const needsCustody = keywords.includes('CUSTODIA');
                const mentionsPole11m = keywords.includes('POSTE 11m') || keywords.includes('HIDRO');
                let effectiveRadius = PROXIMITY_RADIUS;
                if (needsCustody) effectiveRadius = CUSTODY_RADIUS;
                else if (mentionsPole11m) effectiveRadius = POLE_RADIUS;
                
                if (distance <= effectiveRadius) {
                    foundAlerts++;
                    alertsPanel.appendChild(createTaskAlertCard(task, distance, effectiveRadius));
                    const popupContent = `<div class="w-64"><h3 class="font-bold text-red-700">Tarea: ${task.id}</h3><p class="text-sm"><strong>Dirección:</strong> ${task.direccion}</p><p class="text-sm"><strong>Causal:</strong> ${task.causal}</p><hr class="my-1"><p class="text-sm font-medium"><strong>Observaciones:</strong></p><p class="text-sm italic bg-red-50 p-1 rounded">${task.obs}</p></div>`;
                    L.marker(task.latlng, { icon: taskIcon }).bindPopup(popupContent).addTo(proximityTaskLayerGroup);
                }
            });

            if (foundAlerts === 0) {
                alertsPanel.innerHTML = `<div class="text-center text-gray-500 italic">No se encontraron alertas en los radios de búsqueda.</div>`;
            }
        }

        function createPoleAlertCard(pole, distance, effectiveRadius) {
            const el = document.createElement('div');
            el.className = 'bg-white border-l-4 border-blue-500 p-3 rounded-r-lg shadow';
            const radiusText = ` <span class="font-bold text-blue-700">(Detectado en radio ${effectiveRadius}m)</span>`;
            el.innerHTML = `<h4 class="font-bold text-blue-700">POSTE 11m CERCANO</h4><p class="text-sm text-gray-600">A ${distance.toFixed(0)}m de distancia${radiusText}.</p><p class="text-sm mt-1"><strong>ID:</strong> ${pole.id}</p><p class="text-sm"><strong>Desc:</strong> ${pole.desc}</p><p class="text-sm font-semibold text-blue-800 bg-blue-100 p-2 mt-2 rounded">Requerimiento probable: HIDROELEVADOR</p>`;
            return el;
        }

        function createTaskAlertCard(task, distance, effectiveRadius) {
            const el = document.createElement('div');
            el.className = 'bg-white border-l-4 border-red-500 p-3 rounded-r-lg shadow';
            const keywords = analyzeKeywords(task.obs);
            let keywordHTML = '';
            if (keywords.length > 0) {
                const keywordsWithTime = keywords.map(kw => (kw === 'CUSTODIA' && task.plannedTime && task.plannedTime !== 'N/A') ? `<span class="font-bold">CUSTODIA (Horario: ${task.plannedTime})</span>` : kw);
                keywordHTML = `<p class="text-sm font-semibold text-red-800 bg-red-100 p-2 mt-2 rounded">Requerimientos detectados: ${keywordsWithTime.join(', ')}</p>`;
            } else {
                 keywordHTML = `<p class="text-sm font-semibold text-gray-800 bg-gray-100 p-2 mt-2 rounded">Sin requerimientos especiales detectados en obs.</p>`;
            }
            let radiusText = '';
            if (effectiveRadius === CUSTODY_RADIUS) radiusText = ` <span class="font-bold text-red-700">(Detectado en radio ${CUSTODY_RADIUS}m)</span>`;
            else if (effectiveRadius === POLE_RADIUS) radiusText = ` <span class="font-bold text-blue-700">(Detectado en radio ${POLE_RADIUS}m por mención de poste/hidro)</span>`;
            el.innerHTML = `<h4 class="font-bold text-red-700">TAREA CERCANA</h4><p class="text-sm text-gray-600">A ${distance.toFixed(0)}m de distancia${radiusText}.</p><p class="text-sm mt-1"><strong>ID:</strong> ${task.id}</p><p class="text-sm"><strong>Causal:</strong> ${task.causal}</p><p class="text-sm mt-1"><strong>Observaciones:</strong></p><p class="text-xs italic bg-gray-50 p-1 rounded">${task.obs}</p>${keywordHTML}`;
            return el;
        }

        function analyzeKeywords(text) {
            if (!text) return [];
            const lowerText = text.toLowerCase();
            const found = [];
            if (lowerText.includes('hidro') || lowerText.includes('hidroelevador')) found.push('HIDRO');
            if (lowerText.includes('custodia') || lowerText.includes('policia') || lowerText.includes('policía') || lowerText.includes('peligro') || lowerText.includes('zona peligrosa') || lowerText.includes('inseguro')) found.push('CUSTODIA');
            if (lowerText.includes('11m') || lowerText.includes('11 m') || lowerText.includes('11mtrs') || lowerText.includes('postacion de 11 m')) found.push('POSTE 11m');
            if (lowerText.includes('7,5m') || lowerText.includes('7,5 m') || lowerText.includes('7,5mtrs') || lowerText.includes('7.5m') || lowerText.includes('7.5 m') || lowerText.includes('7.5mtrs')) found.push('POSTE 7.5m');
            if (lowerText.includes('deriva')) found.push('DERIVADO');
            return found;
        }
    </script>
</body>

</html>






